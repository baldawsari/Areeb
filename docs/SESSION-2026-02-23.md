# Session Notes — 2026-02-23

## Problem

Sending text to the Telegram bot `@AreebAgentsBot` produced no response.

---

## Root Causes Found

1. **Docker gateway container crash-looping** — `node:22-slim` image has no `git` binary; `npm install -g openclaw@latest` requires git and fails with `ENOENT spawn git`.
2. **Wrong gateway start command** — `openclaw gateway start` uses systemd/launchd (not available in Docker). Must use `openclaw gateway run` (foreground) inside a container.
3. **Config not found in container** — OpenClaw reads config from `~/.openclaw/openclaw.json`, not from the volume-mounted `/app/config.yaml`. The Docker named volume `openclaw-data:/root/.openclaw` overwrites the home directory.
4. **Telegram plugin disabled** — Bundled plugins are disabled by default. The config key `plugins.entries.telegram.enabled: true` is required. The `openclaw plugins enable telegram` CLI command alone was not sufficient; it toggled `channels.telegram.enabled` but missed the `plugins.entries` key.
5. **No routing bindings in live config** — The project `config.yaml` defines bindings, but OpenClaw's runtime config (`~/.openclaw/openclaw.json`) had `bindings: []`. Messages arrived but had nowhere to route.
6. **DM policy blocked messages** — `dmPolicy: "pairing"` requires explicit approval of each sender. Changed to `"open"` with `allowFrom: ["*"]` for development.
7. **Wrong ADMIN_TELEGRAM_ID** — Was set to `8774734968` (the bot's own ID, same as the bot token prefix). The correct user ID is `6901856203` (obtained via `@userinfobot`).
8. **QMD container failing** — `bunx qmd serve` doesn't work; QMD must be installed from GitHub: `bun install -g https://github.com/tobi/qmd`.
9. **Anthropic API credits** — First request failed with "credit balance too low". Subsequent requests worked after credits became available.

---

## Changes Made

### `openclaw/.env`

```diff
- ADMIN_TELEGRAM_ID=8774734968
+ ADMIN_TELEGRAM_ID=6901856203
```

### `openclaw/config.yaml`

```diff
  gateway:
+   mode: "local"
-   host: "127.0.0.1"
+   host: "0.0.0.0"
    port: 18789

  agents:
    defaults:
      memory:
-       backend: "qmd"
-       qmd:
-         paths:
-           - "./workspace/memory"
-         sessions:
-           enabled: true
-         interval: 300
-       temporalDecay:
-         enabled: true
-       mmrDedup:
-         enabled: true
+       backend: "markdown"
+       markdown:
+         paths:
+           - "./workspace/memory"

  channels:
    slack:
-     enabled: true
+     enabled: false

    voice:
-     enabled: true
+     enabled: false
```

### `docker-compose.yml`

```diff
- version: "3.9"
  services:
    openclaw-gateway:
      command: >
-       sh -c "npm install -g openclaw@latest &&
-              openclaw gateway start"
+       sh -c "apt-get update && apt-get install -y git &&
+              npm install -g openclaw@latest &&
+              cp /app/config.yaml /root/.openclaw/config.yaml &&
+              cat /root/.openclaw/config.yaml &&
+              OPENCLAW_HOME=/root/.openclaw openclaw gateway run --allow-unconfigured --verbose"

    qmd:
      command: >
-       sh -c "bunx qmd serve --port 9876"
+       sh -c "apt-get update && apt-get install -y git &&
+              bun install -g https://github.com/tobi/qmd &&
+              qmd serve --port 9876"
```

### `~/.openclaw/openclaw.json` (local runtime — working config)

This is the config that was proven working locally. It must be replicated inside the Docker container at `/root/.openclaw/openclaw.json`:

```json
{
  "agents": {
    "defaults": {
      "contextPruning": { "mode": "cache-ttl", "ttl": "1h" },
      "compaction": { "mode": "safeguard" },
      "heartbeat": { "every": "30m" }
    }
  },
  "bindings": [
    {
      "agentId": "main",
      "match": { "channel": "*" }
    }
  ],
  "channels": {
    "telegram": {
      "enabled": true,
      "dmPolicy": "open",
      "botToken": "${TELEGRAM_BOT_TOKEN}",
      "allowFrom": ["*"],
      "groupPolicy": "allowlist",
      "streaming": "off"
    }
  },
  "gateway": {
    "port": 18789,
    "mode": "local",
    "auth": {
      "mode": "token",
      "token": "<generate-a-new-token>"
    }
  },
  "plugins": {
    "entries": {
      "telegram": {
        "enabled": true
      }
    }
  }
}
```

---

## What Works Now (verified locally)

- OpenClaw gateway v2026.2.22-2 runs on `ws://127.0.0.1:18789`
- Telegram plugin loads and connects as `@AreebAgentsBot`
- Messages from Telegram user `6901856203` are received
- Messages are routed to the `main` agent (claude-opus-4-6)
- AI responses are generated and sent back to Telegram
- Gateway log confirms: `telegram sendMessage ok chat=6901856203`

---

## What Needs to Be Done Next

All work below must target **Docker deployment** (not local) for security — API keys and bot tokens should not be exposed on the host machine.

### 1. Fix Docker Gateway Container

The gateway container still does not start correctly. The key issues:

- **`openclaw gateway run` ignores `/app/config.yaml`** — OpenClaw only reads `~/.openclaw/openclaw.json`. The `docker-compose.yml` copies config.yaml but the gateway expects JSON format at a different path.
- **Solution**: Generate a proper `openclaw.json` file (see the working config above) and mount it directly into the container. Replace the current approach:

```yaml
openclaw-gateway:
  volumes:
    - ./openclaw:/app
    - ./openclaw/openclaw.json:/root/.openclaw/openclaw.json  # <-- mount the runtime config directly
    - openclaw-data:/root/.openclaw/agents
```

- **`openclaw gateway run` needs `--allow-unconfigured`** or `gateway.mode: "local"` in the JSON config.
- **Slow startup**: `apt-get install git` + `npm install -g openclaw` runs on every container restart. Consider building a custom Dockerfile to bake these in.

### 2. Register the 6 Agents in OpenClaw Runtime

The project `config.yaml` defines 6 agents (analyst, pm, architect, developer, tester, scrum-master) but the live `openclaw.json` only has a `main` agent. To wire multi-agent:

- Use `openclaw agents` CLI to register each agent, or add them to `openclaw.json` under an `agents.list` key (check OpenClaw docs for the correct JSON schema — `config.yaml` uses a different format than `openclaw.json`).
- Each agent needs its own `agentDir` with `SOUL.md` and `AGENTS.md` (already exist at `openclaw/agents/<id>/`).
- Update `bindings` to route Telegram messages to specific agents (e.g., `analyst` for DMs, `scrum-master` for groups).

### 3. Wire Bindings for Multi-Agent Routing

Replace the current catch-all binding:

```json
"bindings": [{ "agentId": "main", "match": { "channel": "*" } }]
```

With per-agent routing from `config.yaml`:

```json
"bindings": [
  { "agentId": "analyst", "match": { "channel": "telegram", "peer": "direct:6901856203" } },
  { "agentId": "scrum-master", "match": { "channel": "slack" } },
  { "agentId": "analyst", "match": { "channel": "*" } }
]
```

Note: The `peer` format for Telegram is `direct:<user-id>`. Verify the exact field names against OpenClaw docs.

### 4. Connect Dashboard to Live Gateway

The dashboard (`dashboard/src/lib/store.js`) uses hardcoded sample data. It needs to:

- Connect to the OpenClaw gateway WebSocket at `ws://openclaw-gateway:18789` (Docker internal network).
- Use the gateway auth token from `openclaw.json` → `gateway.auth.token`.
- Replace `SAMPLE_TASKS` and `SAMPLE_MESSAGES` with live data from the gateway API.
- Relevant gateway methods to explore: `channels.status`, `sessions`, `health`.

### 5. Re-enable QMD Memory Backend

Once the QMD container is running (fix: `bun install -g https://github.com/tobi/qmd`):

- Switch memory backend from `"markdown"` back to `"qmd"` in the agent config.
- Ensure the QMD service is reachable from the gateway container on the Docker network at `http://agent-team-qmd:9876`.

### 6. Enable Slack and Voice (When Ready)

- **Slack**: Create a Slack app at api.slack.com, get bot token (`xoxb-...`) and app token (`xapp-...`), enable socket mode, update `.env`, set `channels.slack.enabled: true`, enable the `slack` plugin via `plugins.entries.slack.enabled: true`.
- **Voice**: ElevenLabs key is already in `.env`. Enable the `voice-call` plugin and set `channels.voice.enabled: true`.

### 7. Security: Rotate Exposed Keys

The `.env` file with real API keys was committed to git. **Rotate immediately**:

- Anthropic API key
- Telegram bot token
- ElevenLabs API key

Then add to `.gitignore`:

```
openclaw/.env
```

---

## Key Learnings for Docker Deployment

| Discovery | Detail |
|-----------|--------|
| OpenClaw config location | `~/.openclaw/openclaw.json` (JSON), NOT `config.yaml` |
| Gateway foreground mode | `openclaw gateway run` (not `start` which needs systemd) |
| Plugin enablement | Requires `plugins.entries.<id>.enabled: true` in JSON config |
| Telegram DM policy | `"pairing"` blocks unknown senders; use `"open"` + `allowFrom: ["*"]` for dev |
| Telegram peer format | `direct:<numeric-user-id>` in routing bindings |
| Docker git dependency | `node:22-slim` has no git; must `apt-get install -y git` before `npm install -g openclaw` |
| QMD install | `bun install -g https://github.com/tobi/qmd` (not `bunx qmd`) |
| Bot token vs user ID | Bot token prefix (before `:`) is the bot's ID, not the admin user ID |
| JSON binding field | Use `agentId` (not `agent`) in bindings — YAML config uses different field names |
| Gateway bind for Docker | Use `"bind": "lan"` (binds to 0.0.0.0) — required for Docker port mapping |
| Gateway foreground | `openclaw gateway --verbose --allow-unconfigured` (bare command = foreground mode) |
| Agent workspace vs agentDir | `workspace` = where SOUL.md lives (read), `agentDir` = state/sessions (write) |
| Config validation | Strict Zod schema — unknown keys or `description` on agents causes boot failure |

---

## Session 2 Changes (continued)

### Created: `openclaw/openclaw.json`

The proper runtime config that OpenClaw actually reads. Includes:
- All 6 agents registered in `agents.list` with `workspace` pointing to `/app/agents/<id>` (Docker path)
- Telegram channel with `dmPolicy: "open"`, `allowFrom: ["*"]`
- Bindings: Telegram DM to analyst + catch-all fallback to analyst
- Gateway auth via `${OPENCLAW_GATEWAY_TOKEN}` env var
- `bind: "lan"` for Docker accessibility
- Plugin enablement for Telegram

### Updated: `docker-compose.yml`

- **Fixed volume strategy**: mount `openclaw.json` directly to `/root/.openclaw/openclaw.json:ro` instead of copying config.yaml
- **Separate named volume**: `openclaw-agents:/root/.openclaw/agents` for session state only (not the whole `~/.openclaw`)
- **Fixed gateway command**: `openclaw gateway --verbose --allow-unconfigured` (foreground mode)
- **Separated QMD volumes**: QMD gets its own `qmd-data` volume instead of sharing `openclaw-data`

### Updated: `openclaw/.env`

- Added `OPENCLAW_GATEWAY_TOKEN` for gateway auth (used by both gateway and dashboard)

### Created: `dashboard/src/lib/gateway.js`

WebSocket client for the OpenClaw gateway protocol:
- Handles challenge/connect handshake with auth
- Auto-reconnect with exponential backoff (1s → 30s max)
- Request/response RPC (with 15s timeout)
- Event subscription system
- Convenience methods: `health()`, `listSessions()`, `sessionHistory()`, `channelsStatus()`, `sendToSession()`

### Updated: `dashboard/src/lib/store.js`

- Added `connectionStatus` state (disconnected/connecting/connected/error)
- Added `connectGateway(url, token)` and `disconnectGateway()` actions
- On connect: fetches sessions list, builds live message history, replaces sample messages
- Subscribes to `session.message` events for real-time message updates
- Subscribes to `agent.turn.start/end` events to update agent working/idle status
- Falls back to sample data when disconnected

### Updated: `dashboard/src/components/Header.jsx`

- Added connection status indicator (Offline/Connecting/Live/Error) with colored pill
- Click to toggle connection
- Auto-connects on mount if `VITE_GATEWAY_TOKEN` env var is set

### Updated: `dashboard/src/components/MessageFeed.jsx`

- Added `getAgent()` helper that falls back gracefully for unknown agent IDs (e.g., 'user' from live messages)

### Created: `dashboard/.env`

- `VITE_GATEWAY_URL=ws://localhost:18789`
- `VITE_GATEWAY_TOKEN=<same token as OPENCLAW_GATEWAY_TOKEN>`

---

## Completed

| # | Task | Status |
|---|------|--------|
| 1 | Fix Docker Gateway Container | DONE — openclaw.json created, docker-compose fixed |
| 2 | Register 6 Agents | DONE — all 6 in agents.list (analyst switched to sonnet) |
| 3 | Wire Bindings | DONE — telegram DM + catch-all to analyst |
| 4 | Connect Dashboard to Live Gateway | DONE — WebSocket client + store integration |
| 5 | Docker deployment verified | DONE — all 3 containers running, Telegram bot responding |
| 6 | Analyst model fix | DONE — switched from opus to sonnet 4.6 (config + SOUL.md) |

## TODO for Next Session

### Priority 1 — Per-Agent Routing

All Telegram messages currently go to analyst. Wire routing so users can reach specific agents:
- Option A: Telegram command prefixes (`/architect design a system for...`)
- Option B: Keyword-based routing in bindings
- Option C: Let analyst delegate to other agents via `sessions_send` tool (already in SOUL.md handoff protocol)
- Need to decide which approach fits best

### Priority 2 — Custom Dockerfile

`apt-get install git` + `npm install -g openclaw` runs on every container restart (~20s). Build a custom image:
```dockerfile
FROM node:22-slim
RUN apt-get update && apt-get install -y git && npm install -g openclaw@latest && apt-get clean
```
This makes restarts instant.

### Priority 3 — Key Rotation

API keys may be in git history from earlier commits. Rotate:
- Anthropic API key (`sk-ant-...`)
- Telegram bot token (`8774734968:...`)
- ElevenLabs API key (`sk_a5e8...`)

### Priority 4 — QMD Memory Backend

QMD container is running but not connected to agents. To enable:
- Switch `agents.defaults` memory from markdown to qmd in openclaw.json
- Need an embedding provider (OpenAI, Gemini, Voyage, or Mistral API key) — gateway doctor flagged this
- QMD service at `http://agent-team-qmd:9876` on Docker network

### Priority 5 — Dashboard Live Data

WebSocket client is built but needs testing with real gateway connection:
- Verify `VITE_GATEWAY_TOKEN` auto-connect works
- Tasks are still sample data — gateway doesn't track Kanban tasks natively
- Options: store tasks in agent shared memory, or add a lightweight task API
- Replace sample messages with live session history when connected

### Priority 6 — Slack Channel

Requires creating a Slack app:
1. Create app at api.slack.com
2. Enable socket mode
3. Get bot token (`xoxb-...`) and app token (`xapp-...`)
4. Add to `openclaw/.env`
5. Add to `openclaw.json`: `channels.slack.enabled: true` + `plugins.entries.slack.enabled: true`
6. Add slack binding for scrum-master agent

### Priority 7 — Voice Channel

ElevenLabs key already in `.env`. Just needs:
- `channels.voice.enabled: true` in openclaw.json
- `plugins.entries["talk-voice"].enabled: true`

### Priority 8 — EBUSY Config Warning

The read-only mount (`:ro`) prevents gateway from writing to openclaw.json, causing harmless `EBUSY` errors in logs. Options:
- Remove `:ro` flag (lets gateway auto-modify config — less controlled)
- Keep `:ro` and ignore the warnings (current approach)
- Copy config on startup instead of bind-mounting
